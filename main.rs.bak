// Command-line entry point for TraceCraft.

use clap::Parser;
use tracecraft::application::AnalyzeUsecase;
use tracecraft::infrastructure::{SynAstParser, SimpleCallGraphBuilder, DotExporter};

/// TraceCraft - Rust static analysis tool for multi-crate workspaces.
#[derive(Parser, Debug)]
#[command(author, version, about, long_about = None)]
struct Cli {
    /// Input source file path (currently accepts .rs only)
    #[arg(short, long)]
    input: String,

    /// Output file path
    #[arg(short, long)]
    output: String,

    /// Output format (dot, json, text)
    #[arg(short, long, default_value = "dot")]
    format: String,
}

fn main() {
    let cli = Cli::parse();
    // Read the input file
    let src_code = std::fs::read_to_string(&cli.input)
        .unwrap_or_else(|_| "// Fallback: file not found or unreadable.".to_string());

    let usecase = AnalyzeUsecase {
        parser: &SynAstParser,
        callgraph_builder: &SimpleCallGraphBuilder,
        exporter: &DotExporter,
    };

    let result = usecase.run(&src_code, &cli.output);

    match result {
        Ok(_) => println!(
            "Analysis completed! Output written to {} (format: {})",
            cli.output, cli.format
        ),
        Err(e) => eprintln!("Error: {:?}", e),
    }
}
